name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    name: CI

    on:
      push:
        branches: [ main, master, develop ]
      pull_request:
        branches: [ main, master, develop ]

    jobs:
      test:
        name: Hardhat tests (Node ${{ matrix.node }})
        runs-on: ubuntu-latest
        strategy:
          matrix:
            node: ['22']
        steps:
          - name: Checkout repository
            uses: actions/checkout@v4

          - name: Cache node modules
            uses: actions/cache@v4
            with:
              path: |
                ~/.npm
                node_modules
              key: ${{ runner.os }}-node-${{ matrix.node }}-${{ hashFiles('**/package-lock.json') }}
              restore-keys: |
                ${{ runner.os }}-node-${{ matrix.node }}-

          - name: Setup Node.js
            uses: actions/setup-node@v4
            with:
              node-version: ${{ matrix.node }}
              cache: 'npm'

          - name: Install dependencies
            run: npm ci

          - name: Compile contracts
            run: npx hardhat compile

          - name: Run Hardhat tests
            run: npx hardhat test
            env:
              CI: true

      slither:
        name: Static analysis (Slither)
        runs-on: ubuntu-latest
        needs: test
        steps:
          - name: Checkout repository
            uses: actions/checkout@v4

          - name: Run Slither via Docker
            run: |
              docker run --rm -v ${{ github.workspace }}:/src -w /src trailofbits/slither slither --exclude test .

      coverage:
        name: Coverage (optional)
        runs-on: ubuntu-latest
        needs: test
        steps:
          - name: Checkout repository
            uses: actions/checkout@v4

          - name: Setup Node.js
            uses: actions/setup-node@v4
            with:
              node-version: '22'

          - name: Install dependencies
            run: npm ci

          - name: Generate coverage indicator
            id: generatecov
            run: |
              if [ -f coverage/lcov.info ]; then echo "exists=true" >> $GITHUB_OUTPUT; else echo "exists=false" >> $GITHUB_OUTPUT; fi

          - name: Upload coverage to Codecov
            if: steps.generatecov.outputs.exists == 'true'
            uses: codecov/codecov-action@v4
            with:
              files: coverage/lcov.info
              fail_ci_if_error: false

      lint:
        name: Lint (ESLint)
        runs-on: ubuntu-latest
        steps:
          - name: Checkout repository
            uses: actions/checkout@v4

          - name: Setup Node.js
            uses: actions/setup-node@v4
            with:
              node-version: '22'

          - name: Install dependencies (root)
            run: npm ci
            env:
              CI: true

          - name: Run ESLint on repo
            run: npx eslint --ext .js,.ts . || true

      audit:
        name: NPM Audit (root + frontend)
        runs-on: ubuntu-latest
        needs: test
        steps:
          - name: Checkout repository
            uses: actions/checkout@v4

          - name: Setup Node.js
            uses: actions/setup-node@v4
            with:
              node-version: '22'

          - name: Install dependencies (root)
            run: npm ci
            env:
              CI: true

          - name: Run npm audit (root)
            run: npm audit --audit-level=moderate || true

          - name: Install frontend deps
            working-directory: frontend
            run: npm ci

          - name: Run npm audit (frontend)
            working-directory: frontend
            run: npm audit --audit-level=moderate || true

      frontend_build:
        name: Frontend build
        runs-on: ubuntu-latest
        needs: test
        steps:
          - name: Checkout repository
            uses: actions/checkout@v4

          - name: Setup Node.js for frontend
            uses: actions/setup-node@v4
            with:
              node-version: '22'
              cache: 'npm'

          - name: Install frontend dependencies
            working-directory: frontend
            run: npm ci

          - name: Build frontend
            working-directory: frontend
            run: npm run build
    name: Hardhat tests (Node ${{ matrix.node }})
